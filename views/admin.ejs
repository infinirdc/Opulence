<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opulence - Administration</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-body">
    <!-- Admin Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h2 class="admin-logo">
                <i class="fas fa-crown"></i>
                Opulence Admin
            </h2>
            <a href="/" class="btn-back">
                <i class="fas fa-home"></i> Site public
            </a>
        </div>
        
        <nav class="admin-nav">
            <a href="#dashboard" class="nav-item active" data-target="dashboard">
                <i class="fas fa-chart-line"></i>
                <span>Tableau de bord</span>
            </a>
            <a href="#stocks" class="nav-item" data-target="stocks">
                <i class="fas fa-boxes"></i>
                <span>Gestion des Stocks</span>
            </a>
            <a href="#plats" class="nav-item" data-target="plats">
                <i class="fas fa-utensils"></i>
                <span>Gestion des Plats</span>
            </a>
            <a href="#commandes" class="nav-item" data-target="commandes">
                <i class="fas fa-receipt"></i>
                <span>Commandes</span>
            </a>
            <a href="/admin/logout" class="nav-item logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <p class="admin-info">
                <i class="fas fa-user-shield"></i>
                Session administrateur
            </p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Dashboard Section -->
        <section id="dashboard" class="admin-section active">
            <div class="section-header">
                <h1 class="section-title">Tableau de bord</h1>
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Ingrédients en stock</h3>
                            <p class="stat-number" id="ingredientsCount">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Plats disponibles</h3>
                            <p class="stat-number" id="platsCount">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Commandes aujourd'hui</h3>
                            <p class="stat-number" id="ordersToday">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Alertes stock</h3>
                            <p class="stat-number" id="stockAlerts">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <!-- Alertes de stock bas -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-bell"></i>
                        Alertes stock critique
                    </h3>
                    <div class="card-content">
                        <div id="stockAlertsList">
                            <!-- Les alertes seront insérées ici -->
                        </div>
                    </div>
                </div>
                
                <!-- Dernières commandes -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-clock"></i>
                        Commandes récentes
                    </h3>
                    <div class="card-content">
                        <div id="recentOrders">
                            <!-- Les commandes récentes seront insérées ici -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stocks Section -->
        <section id="stocks" class="admin-section">
            <div class="section-header">
                <h1 class="section-title">Gestion des Stocks</h1>
                <button class="btn btn-primary" onclick="showIngredientForm()">
                    <i class="fas fa-plus"></i> Nouvel ingrédient
                </button>
            </div>
            
            <!-- Formulaire d'ajout d'ingrédient (caché par défaut) -->
            <div class="form-card" id="ingredientForm" style="display: none;">
                <h3>Ajouter un nouvel ingrédient</h3>
                <form id="addIngredientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="ingredientName">Nom de l'ingrédient</label>
                            <input type="text" id="ingredientName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="ingredientUnit">Unité de mesure</label>
                            <select id="ingredientUnit" class="form-select" required>
                                <option value="g">Grammes (g)</option>
                                <option value="kg">Kilogrammes (kg)</option>
                                <option value="ml">Millilitres (ml)</option>
                                <option value="L">Litres (L)</option>
                                <option value="unité">Unité</option>
                                <option value="pièce">Pièce</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ingredientStock">Stock initial</label>
                            <input type="number" id="ingredientStock" class="form-input" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="ingredientAlert">Seuil d'alerte</label>
                            <input type="number" id="ingredientAlert" class="form-input" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideIngredientForm()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Tableau des ingrédients -->
            <div class="table-card">
                <h3>Liste des ingrédients</h3>
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Unité</th>
                                <th>Stock actuel</th>
                                <th>Seuil d'alerte</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ingredientsTable">
                            <% if (ingredients && ingredients.length > 0) { %>
                                <% ingredients.forEach(ing => { %>
                                    <tr data-id="<%= ing._id %>" 
                                        class="<%= ing.stock <= ing.seuilAlerte ? 'stock-low' : '' %>">
                                        <td><%= ing.nom %></td>
                                        <td><%= ing.unite %></td>
                                        <td>
                                            <input type="number" 
                                                   class="stock-input" 
                                                   value="<%= ing.stock %>" 
                                                   data-id="<%= ing._id %>"
                                                   min="0"
                                                   step="0.01">
                                        </td>
                                        <td><%= ing.seuilAlerte %></td>
                                        <td>
                                            <% if (ing.stock <= ing.seuilAlerte) { %>
                                                <span class="badge badge-warning">
                                                    <i class="fas fa-exclamation-triangle"></i> Critique
                                                </span>
                                            <% } else if (ing.stock <= ing.seuilAlerte * 2) { %>
                                                <span class="badge badge-info">
                                                    <i class="fas fa-info-circle"></i> Attention
                                                </span>
                                            <% } else { %>
                                                <span class="badge badge-success">
                                                    <i class="fas fa-check"></i> Bon niveau
                                                </span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <button class="btn-icon" 
                                                    onclick="updateStock('<%= ing._id %>')"
                                                    title="Mettre à jour">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6" class="empty-table">
                                        <i class="fas fa-box-open"></i>
                                        <p>Aucun ingrédient enregistré</p>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Plats Section -->
        <section id="plats" class="admin-section">
            <div class="section-header">
                <h1 class="section-title">Gestion des Plats</h1>
                <button class="btn btn-primary" onclick="showPlatForm()">
                    <i class="fas fa-plus"></i> Nouveau plat
                </button>
            </div>
            
            <!-- Formulaire d'ajout de plat -->
            <div class="form-card" id="platForm" style="display: none;">
                <h3>Ajouter un nouveau plat</h3>
                <form id="addPlatForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="platName">Nom du plat</label>
                            <input type="text" id="platName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="platPrice">Prix (€)</label>
                            <input type="number" id="platPrice" class="form-input" min="0" step="0.01" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="platDescription">Description</label>
                            <textarea id="platDescription" class="form-textarea" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <!-- Ingédients du plat -->
                    <div class="form-section">
                        <h4>Ingrédients du plat</h4>
                        <div id="platIngredients">
                            <div class="ingredient-row">
                                <select class="form-select ingredient-select">
                                    <option value="">Sélectionner un ingrédient</option>
                                    <% if (ingredients && ingredients.length > 0) { %>
                                        <% ingredients.forEach(ing => { %>
                                            <option value="<%= ing._id %>"><%= ing.nom %> (<%= ing.unite %>)</option>
                                        <% }) %>
                                    <% } %>
                                </select>
                                <input type="number" 
                                       class="form-input ingredient-qty" 
                                       placeholder="Quantité" 
                                       min="0" 
                                       step="0.01">
                                <button type="button" class="btn btn-secondary" onclick="removeIngredientRow(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addIngredientRow()">
                            <i class="fas fa-plus"></i> Ajouter un ingrédient
                        </button>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="hidePlatForm()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer le plat
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Tableau des plats -->
            <div class="table-card">
                <h3>Liste des plats</h3>
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Description</th>
                                <th>Prix</th>
                                <th>Ingrédients</th>
                                <th>Disponible</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="platsTable">
                            <% if (plats && plats.length > 0) { %>
                                <% plats.forEach(plat => { %>
                                    <tr data-id="<%= plat._id %>">
                                        <td><strong><%= plat.nom %></strong></td>
                                        <td><%= plat.description %></td>
                                        <td><%= plat.prix.toFixed(2) %> €</td>
                                        <td>
                                            <% if (plat.ingredients && plat.ingredients.length > 0) { %>
                                                <ul class="ingredients-list">
                                                    <% plat.ingredients.forEach(ing => { %>
                                                        <li>
                                                            <%= ing.quantite %> 
                                                            <%= ing.ingredient.unite %> 
                                                            <%= ing.ingredient.nom %>
                                                        </li>
                                                    <% }) %>
                                                </ul>
                                            <% } else { %>
                                                <span class="text-muted">Aucun ingrédient</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <label class="switch">
                                                <input type="checkbox" 
                                                       <%= plat.disponible ? 'checked' : '' %>
                                                       onchange="togglePlatDisponible('<%= plat._id %>', this.checked)">
                                                <span class="slider"></span>
                                            </label>
                                        </td>
                                        <td>
                                            <button class="btn-icon" 
                                                    onclick="editPlat('<%= plat._id %>')"
                                                    title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6" class="empty-table">
                                        <i class="fas fa-utensils"></i>
                                        <p>Aucun plat enregistré</p>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Commandes Section -->
        <section id="commandes" class="admin-section">
            <div class="section-header">
                <h1 class="section-title">Gestion des Commandes</h1>
                <div class="filter-buttons">
                    <button class="btn-filter active" data-filter="all">Toutes</button>
                    <button class="btn-filter" data-filter="en attente">En attente</button>
                    <button class="btn-filter" data-filter="en préparation">En préparation</button>
                    <button class="btn-filter" data-filter="prête">Prêtes</button>
                </div>
            </div>
            
            <div class="table-card">
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID Commande</th>
                                <th>Client</th>
                                <th>Téléphone</th>
                                <th>Plats</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="commandesTable">
                            <% if (commandes && commandes.length > 0) { %>
                                <% commandes.forEach(commande => { %>
                                    <tr data-id="<%= commande._id %>" data-status="<%= commande.statut %>">
                                        <td>#<%= commande._id.toString().slice(-6) %></td>
                                        <td><%= commande.nomClient %></td>
                                        <td><%= commande.telephone %></td>
                                        <td>
                                            <% if (commande.plats && commande.plats.length > 0) { %>
                                                <ul class="order-items">
                                                    <% commande.plats.forEach(item => { %>
                                                        <li>
                                                            <%= item.quantite %>x 
                                                            <% if (item.plat) { %>
                                                                <%= item.plat.nom %>
                                                            <% } else { %>
                                                                Plat supprimé
                                                            <% } %>
                                                        </li>
                                                    <% }) %>
                                                </ul>
                                            <% } %>
                                        </td>
                                        <td><%= commande.total ? commande.total.toFixed(2) : '0.00' %> €</td>
                                        <td>
                                            <%= new Date(commande.date).toLocaleDateString('fr-FR') %>
                                            <br>
                                            <small><%= new Date(commande.date).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) %></small>
                                        </td>
                                        <td>
                                            <select class="status-select" 
                                                    data-id="<%= commande._id %>"
                                                    onchange="updateOrderStatus('<%= commande._id %>', this.value)">
                                                <option value="en attente" <%= commande.statut === 'en attente' ? 'selected' : '' %>>En attente</option>
                                                <option value="en préparation" <%= commande.statut === 'en préparation' ? 'selected' : '' %>>En préparation</option>
                                                <option value="prête" <%= commande.statut === 'prête' ? 'selected' : '' %>>Prête</option>
                                                <option value="livrée" <%= commande.statut === 'livrée' ? 'selected' : '' %>>Livrée</option>
                                                <option value="annulée" <%= commande.statut === 'annulée' ? 'selected' : '' %>>Annulée</option>
                                            </select>
                                        </td>
                                        <td>
                                            <button class="btn-icon" 
                                                    onclick="viewOrderDetails('<%= commande._id %>')"
                                                    title="Voir les détails">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="8" class="empty-table">
                                        <i class="fas fa-receipt"></i>
                                        <p>Aucune commande</p>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal pour les détails de commande -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Détails de la commande</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="orderDetails">
                <!-- Les détails seront chargés ici -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Navigation entre sections
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (this.classList.contains('logout')) return;
                
                e.preventDefault();
                const target = this.getAttribute('data-target');
                
                // Mettre à jour la navigation
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // Afficher la section cible
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(target).classList.add('active');
            });
        });
        
        // Filtrage des commandes
        document.querySelectorAll('.btn-filter').forEach(btn => {
            btn.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                
                // Mettre à jour les boutons actifs
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Filtrer les lignes du tableau
                document.querySelectorAll('#commandesTable tr[data-id]').forEach(row => {
                    if (filter === 'all' || row.getAttribute('data-status') === filter) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });
        
        // Mettre à jour le stock d'un ingrédient
        window.updateStock = function(ingredientId) {
            const input = document.querySelector(`.stock-input[data-id="${ingredientId}"]`);
            const stock = parseFloat(input.value);
            
            if (isNaN(stock) || stock < 0) {
                showToast('Valeur de stock invalide', 'error');
                return;
            }
            
            fetch(`/admin/ingredients/${ingredientId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ stock })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Stock mis à jour avec succès', 'success');
                    
                    // Mettre à jour la ligne
                    const row = input.closest('tr');
                    if (stock <= data.ingredient.seuilAlerte) {
                        row.classList.add('stock-low');
                        row.querySelector('.badge').innerHTML = 
                            '<i class="fas fa-exclamation-triangle"></i> Critique';
                        row.querySelector('.badge').className = 'badge badge-warning';
                    } else if (stock <= data.ingredient.seuilAlerte * 2) {
                        row.classList.remove('stock-low');
                        row.querySelector('.badge').innerHTML = 
                            '<i class="fas fa-info-circle"></i> Attention';
                        row.querySelector('.badge').className = 'badge badge-info';
                    } else {
                        row.classList.remove('stock-low');
                        row.querySelector('.badge').innerHTML = 
                            '<i class="fas fa-check"></i> Bon niveau';
                        row.querySelector('.badge').className = 'badge badge-success';
                    }
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showToast('Erreur lors de la mise à jour', 'error');
            });
        };
        
        // Basculer la disponibilité d'un plat
        window.togglePlatDisponible = function(platId, disponible) {
            fetch(`/admin/plats/${platId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ disponible })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`Plat ${disponible ? 'activé' : 'désactivé'}`, 'success');
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showToast('Erreur lors de la mise à jour', 'error');
            });
        };
        
        // Mettre à jour le statut d'une commande
        window.updateOrderStatus = function(orderId, status) {
            fetch(`/admin/commandes/${orderId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ statut: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Statut mis à jour', 'success');
                    
                    // Mettre à jour l'attribut data-status de la ligne
                    const row = document.querySelector(`tr[data-id="${orderId}"]`);
                    if (row) {
                        row.setAttribute('data-status', status);
                    }
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showToast('Erreur lors de la mise à jour', 'error');
            });
        };
        
        // Gestion du formulaire d'ingrédient
        window.showIngredientForm = function() {
            document.getElementById('ingredientForm').style.display = 'block';
            document.getElementById('ingredientName').focus();
        };
        
        window.hideIngredientForm = function() {
            document.getElementById('ingredientForm').style.display = 'none';
            document.getElementById('addIngredientForm').reset();
        };
        
        // Gestion du formulaire de plat
        window.showPlatForm = function() {
            document.getElementById('platForm').style.display = 'block';
            document.getElementById('platName').focus();
        };
        
        window.hidePlatForm = function() {
            document.getElementById('platForm').style.display = 'none';
            document.getElementById('addPlatForm').reset();
            // Réinitialiser les ingrédients
            const container = document.getElementById('platIngredients');
            container.innerHTML = `
                <div class="ingredient-row">
                    <select class="form-select ingredient-select">
                        <option value="">Sélectionner un ingrédient</option>
                        <% if (ingredients && ingredients.length > 0) { %>
                            <% ingredients.forEach(ing => { %>
                                <option value="<%= ing._id %>"><%= ing.nom %> (<%= ing.unite %>)</option>
                            <% }) %>
                        <% } %>
                    </select>
                    <input type="number" 
                           class="form-input ingredient-qty" 
                           placeholder="Quantité" 
                           min="0" 
                           step="0.01">
                    <button type="button" class="btn btn-secondary" onclick="removeIngredientRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        };
        
        window.addIngredientRow = function() {
            const container = document.getElementById('platIngredients');
            const newRow = document.createElement('div');
            newRow.className = 'ingredient-row';
            newRow.innerHTML = `
                <select class="form-select ingredient-select">
                    <option value="">Sélectionner un ingrédient</option>
                    <% if (ingredients && ingredients.length > 0) { %>
                        <% ingredients.forEach(ing => { %>
                            <option value="<%= ing._id %>"><%= ing.nom %> (<%= ing.unite %>)</option>
                        <% }) %>
                    <% } %>
                </select>
                <input type="number" 
                       class="form-input ingredient-qty" 
                       placeholder="Quantité" 
                       min="0" 
                       step="0.01">
                <button type="button" class="btn btn-secondary" onclick="removeIngredientRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newRow);
        };
        
        window.removeIngredientRow = function(button) {
            if (document.querySelectorAll('.ingredient-row').length > 1) {
                button.closest('.ingredient-row').remove();
            }
        };
        
        // Soumission du formulaire d'ingrédient
        document.getElementById('addIngredientForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ingredient = {
                nom: document.getElementById('ingredientName').value,
                unite: document.getElementById('ingredientUnit').value,
                stock: parseFloat(document.getElementById('ingredientStock').value),
                seuilAlerte: parseFloat(document.getElementById('ingredientAlert').value) || 0
            };
            
            fetch('/admin/ingredients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(ingredient)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Ingrédient ajouté avec succès', 'success');
                    hideIngredientForm();
                    // Recharger la page pour voir le nouvel ingrédient
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showToast('Erreur lors de l\'ajout', 'error');
            });
        });
        
        // Soumission du formulaire de plat
        document.getElementById('addPlatForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collecter les ingrédients
            const ingredients = [];
            document.querySelectorAll('.ingredient-row').forEach(row => {
                const select = row.querySelector('.ingredient-select');
                const qtyInput = row.querySelector('.ingredient-qty');
                
                if (select.value && qtyInput.value) {
                    ingredients.push({
                        ingredient: select.value,
                        quantite: parseFloat(qtyInput.value)
                    });
                }
            });
            
            const plat = {
                nom: document.getElementById('platName').value,
                description: document.getElementById('platDescription').value,
                prix: parseFloat(document.getElementById('platPrice').value),
                ingredients: JSON.stringify(ingredients),
                disponible: true
            };
            
            fetch('/admin/plats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(plat)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Plat ajouté avec succès', 'success');
                    hidePlatForm();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showToast('Erreur lors de l\'ajout', 'error');
            });
        });
        
        // Modal pour les détails de commande
        window.viewOrderDetails = function(orderId) {
            fetch(`/admin/commandes/${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const order = data.commande;
                        let html = `
                            <div class="order-details">
                                <div class="detail-row">
                                    <strong>Client:</strong> ${order.nomClient}
                                </div>
                                <div class="detail-row">
                                    <strong>Téléphone:</strong> ${order.telephone}
                                </div>
                                <div class="detail-row">
                                    <strong>Date:</strong> ${new Date(order.date).toLocaleString('fr-FR')}
                                </div>
                                <div class="detail-row">
                                    <strong>Statut:</strong> 
                                    <span class="status-badge ${order.statut.replace(' ', '-')}">
                                        ${order.statut}
                                    </span>
                                </div>
                                <div class="detail-row">
                                    <strong>Total:</strong> ${order.total ? order.total.toFixed(2) : '0.00'} €
                                </div>
                                <div class="detail-section">
                                    <h4>Plats commandés:</h4>
                                    <ul class="order-items-details">
                        `;
                        
                        if (order.plats && order.plats.length > 0) {
                            order.plats.forEach(item => {
                                html += `
                                    <li>
                                        ${item.quantite}x 
                                        ${item.plat ? item.plat.nom : 'Plat supprimé'}
                                        ${item.plat ? `(${item.plat.prix.toFixed(2)} €)` : ''}
                                    </li>
                                `;
                            });
                        }
                        
                        html += `
                                    </ul>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('orderDetails').innerHTML = html;
                        document.getElementById('orderModal').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    showToast('Erreur lors du chargement', 'error');
                });
        };
        
        window.closeModal = function() {
            document.getElementById('orderModal').style.display = 'none';
        };
        
        // Fermer la modal en cliquant en dehors
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
        
        // Fonction de notification
        window.showToast = function(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        };
        
        // Initialisation des statistiques
        document.addEventListener('DOMContentLoaded', function() {
            // Compter les ingrédients
            const ingredientsCount = <%= ingredients ? ingredients.length : 0 %>;
            document.getElementById('ingredientsCount').textContent = ingredientsCount;
            
            // Compter les plats disponibles
            const platsDisponibles = <%= plats ? plats.filter(p => p.disponible).length : 0 %>;
            document.getElementById('platsCount').textContent = platsDisponibles;
            
            // Compter les commandes d'aujourd'hui
            const today = new Date().toDateString();
            const commandesToday = <%= commandes ? commandes.filter(c => new Date(c.date).toDateString() === today).length : 0 %>;
            document.getElementById('ordersToday').textContent = commandesToday;
            
            // Compter les alertes de stock
            const stockAlerts = <%= ingredients ? ingredients.filter(i => i.stock <= i.seuilAlerte).length : 0 %>;
            document.getElementById('stockAlerts').textContent = stockAlerts;
            
            // Afficher les alertes de stock
            const alertsList = document.getElementById('stockAlertsList');
            <% if (ingredients && ingredients.length > 0) { %>
                <% ingredients.forEach(ing => { %>
                    <% if (ing.stock <= ing.seuilAlerte) { %>
                        alertsList.innerHTML += `
                            <div class="alert-item">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong><%= ing.nom %></strong>
                                    <p>Stock: <%= ing.stock %> <%= ing.unite %> (seuil: <%= ing.seuilAlerte %> <%= ing.unite %>)</p>
                                </div>
                            </div>
                        `;
                    <% } %>
                <% }) %>
            <% } %>
            
            // Afficher les commandes récentes
            const recentOrders = document.getElementById('recentOrders');
            <% if (commandes && commandes.length > 0) { %>
                <% commandes.slice(0, 5).forEach(commande => { %>
                    recentOrders.innerHTML += `
                        <div class="order-item">
                            <div class="order-header">
                                <strong>#<%= commande._id.toString().slice(-6) %></strong>
                                <span class="status-badge <%= commande.statut.replace(' ', '-') %>">
                                    <%= commande.statut %>
                                </span>
                            </div>
                            <p><%= commande.nomClient %> - <%= commande.total ? commande.total.toFixed(2) : '0.00' %> €</p>
                            <small><%= new Date(commande.date).toLocaleDateString('fr-FR') %></small>
                        </div>
                    `;
                <% }) %>
            <% } %>
        });
    </script>
</body>
</html>